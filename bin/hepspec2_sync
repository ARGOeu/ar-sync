#!/bin/env python
import pymongo
from pymongo import MongoClient
import urllib
import urllib2
import os
import json
import datetime
import httplib
import sys
import urlparse

defaultGstatRequest = 'http://gstat2.grid.sinica.edu.tw/gstat/summary/json/'

##############################
# send to database
##############################

def updateHEPSPECs():
    # Load cache
    hep_hash = {}
    try:
        with open("hepspec_cache.txt", "r") as f:
            for line in f:
                (key, val) = line.split()
                hep_hash[key] = val
    except IOError, e:
        pass
    
    # Load server data
    urlFile = urllib2.urlopen(defaultGstatRequest)
    json_data = json.load(urlFile)
    for record in json_data:
        if record['HEPSPEC06'] != 0:
            hep_hash[record['Sitename']] = record['HEPSPEC06']
    
    # Merge with database
    for record_site in collection.distinct("s"):
        if not record_site in hep_hash:
            hep_hash[record_site] = 1
        collection.update({"s" : record_site}, {"$set" : { "hs": hep_hash[record_site]}}, manipulate=False, safe=None, multi=True, check_keys=False, w=0)
    
    # Write data to file
    for (key, val) in hep_hash.iteritems():
        with open(hepspec_cache.txt, "w") as f:
            f.write('%s %s' % (key, val))

##############################
# main
##############################
client = MongoClient()
client.write_concern = {'w': 0}
db = client.AR
collection = db.sites

updateHEPSPECs();